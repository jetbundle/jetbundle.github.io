<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% if page.title %}{{ page.title }}{% else %}Differential Equations Laboratory{% endif %}</title>
  <meta name="description" content="{% if page.description %}{{ page.description }}{% else %}Interactive computational textbook for differential equations{% endif %}">

  {% if site.math_engine_client == 'katex' %}
  <!-- KaTeX - PRIORITY: Load immediately for fast math rendering -->
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous"></noscript>

  <!-- Load KaTeX scripts with high priority, no defer -->
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
  <script>
    // Render math immediately when page loads, before heavy scripts
    (function() {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initMath);
      } else {
        initMath();
      }

      function initMath() {
        // Load auto-render script
        var script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js';
        script.integrity = 'sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05';
        script.crossOrigin = 'anonymous';
        script.onload = function() {
          if (window.renderMathInElement) {
            window.renderMathInElement(document.body, {
              delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\[', right: '\\]', display: true},
                {left: '\\(', right: '\\)', display: false}
              ],
              throwOnError: false,
              strict: false,
              trust: true,
              ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
              ignoredClasses: ['no-math']
            });
            console.log('KaTeX math rendered (priority load)');
          }
        };
        document.head.appendChild(script);
      }
    })();
  </script>
  {% else %}
  <!-- MathJax 3 - PRIORITY: Load immediately for fast math rendering -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true,
        tags: 'ams',
        autoload: {
          color: [],
          colorv2: ['color'],
          bbox: ['bbox'],
          cancel: ['cancel', 'bcancel', 'xcancel', 'cancelto'],
          enclose: ['enclose', 'cancel', 'color']
        }
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'table', 'thead', 'tbody', 'tr', 'td', 'th'],
        ignoreHtmlClass: 'no-math',
        processHtmlClass: 'math'
      },
      startup: {
        ready: () => {
          MathJax.startup.defaultReady();
          console.log('MathJax is ready (priority load)');
          fixMathPlaceholders();
        }
      }
    };

    function fixMathPlaceholders() {
      const content = document.querySelector('.textbook-content');
      if (!content) return;
      const walker = document.createTreeWalker(content, NodeFilter.SHOW_TEXT);
      let node;
      while (node = walker.nextNode()) {
        if (node.textContent.includes('MATH_PIPE_PLACEHOLDER_XYZ123')) {
          node.textContent = node.textContent.replace(/MATH_PIPE_PLACEHOLDER_XYZ123/g, '|');
        }
      }
      if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise([content]).catch(err => {
          console.log('MathJax re-render after placeholder fix:', err);
        });
      }
    }

    // Load MathJax immediately (no async/defer) for priority rendering
    (function() {
      var script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.async = false; // Load synchronously to prioritize math rendering
      document.head.appendChild(script);
    })();
  </script>
  {% endif %}

  <!-- Prism.js Syntax Highlighting - Load with defer to not block math rendering -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

  <!-- Textbook CSS -->
  <link rel="stylesheet" href="{{ '/assets/css/textbook.css' | relative_url }}">
</head>
<body class="textbook-body theme-dark">
  {% include theme_toggle.html %}

  <div class="textbook-container">
    <!-- Sidebar Navigation -->
    <nav class="textbook-sidebar">
      {% include textbook_nav.html %}
    </nav>

    <!-- Main Content -->
    <main class="textbook-main">
      <header class="textbook-header">
        <h1>{{ page.title }}</h1>
        {% if page.description %}<p class="description">{{ page.description }}</p>{% endif %}
      </header>

      <article class="textbook-content">
        {{ content }}
      </article>
    </main>
  </div>

  <!-- Heavy Scripts: Load lazily after content and math are rendered -->
  <!-- Pyodide & Plotly - Deferred to not block initial rendering -->
  <script>
    // Lazy load heavy scripts only when needed or after page is fully interactive
    window.addEventListener('load', function() {
      // Load Pyodide and Plotly after page is fully loaded
      // They will be loaded on-demand when code execution buttons are clicked

      // Load Plotly (smaller, can load earlier)
      var plotlyScript = document.createElement('script');
      plotlyScript.src = 'https://cdn.plot.ly/plotly-2.27.0.min.js';
      plotlyScript.charset = 'utf-8';
      plotlyScript.async = true;
      document.body.appendChild(plotlyScript);

      // Pyodide is loaded on-demand by textbook-engine.js when first code block is executed
      // This saves ~10MB on initial page load
    });
  </script>

  <!-- Textbook JavaScript - Load with defer to not block math rendering -->
  <script defer src="{{ '/assets/js/theme-manager.js' | relative_url }}"></script>
  <script defer src="{{ '/assets/js/textbook-engine.js' | relative_url }}"></script>
  <script defer src="{{ '/assets/js/widget-engine.js' | relative_url }}"></script>
  <script defer src="{{ '/assets/js/code-toggle.js' | relative_url }}"></script>
</body>
</html>
