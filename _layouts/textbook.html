<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% if page.title %}{{ page.title }}{% else %}Differential Equations Laboratory{% endif %}</title>
  <meta name="description" content="{% if page.description %}{{ page.description }}{% else %}Interactive computational textbook for differential equations{% endif %}">

  <!-- MathJax 3 - Standards-compliant LaTeX configuration -->
  <script>
    window.MathJax = {
      tex: {
        // Standard LaTeX delimiters
        inlineMath: [['\\(', '\\)']],  // Use \( \) for inline to avoid table conflicts
        displayMath: [['\\[', '\\]']], // Use \[ \] for display
        // Also support $ for compatibility, but with proper escaping
        macros: {
          // Define common macros for consistency
          RR: '{\\mathbb{R}}',
          NN: '{\\mathbb{N}}',
          ZZ: '{\\mathbb{Z}}',
          QQ: '{\\mathbb{Q}}',
          CC: '{\\mathbb{C}}'
        },
        // Process escapes and environments
        processEscapes: true,
        processEnvironments: true,
        // Use AMS math tags
        tags: 'ams',
        // Autoload common packages
        autoload: {
          color: [],
          colorv2: ['color'],
          bbox: ['bbox'],
          cancel: ['cancel', 'bcancel', 'xcancel', 'cancelto'],
          enclose: ['enclose', 'cancel', 'color']
        },
        // Packages to load
        packages: {'[+]': ['ams', 'newcommand', 'configmacros']}
      },
      options: {
        // Skip HTML tags that shouldn't contain math
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
        ignoreHtmlClass: 'no-math',
        processHtmlClass: 'math'
      },
      startup: {
        ready: () => {
          MathJax.startup.defaultReady();
          console.log('MathJax 3 ready with standards-compliant LaTeX configuration');
        }
      }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>

  <!-- Prism.js Syntax Highlighting -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

  <!-- Textbook CSS -->
  <link rel="stylesheet" href="{{ '/assets/css/textbook.css' | relative_url }}">
</head>
<body class="textbook-body theme-dark">
  {% include theme_toggle.html %}

  <div class="textbook-container">
    <!-- Sidebar Navigation -->
    <nav class="textbook-sidebar">
      {% include textbook_nav.html %}
    </nav>

    <!-- Main Content -->
    <main class="textbook-main">
      <header class="textbook-header">
        <h1>{{ page.title }}</h1>
        {% if page.description %}<p class="description">{{ page.description }}</p>{% endif %}
      </header>

      <article class="textbook-content">
        {{ content }}
      </article>
    </main>
  </div>

  <!-- Pyodide & Plotly (Load asynchronously) -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>

  <!-- Textbook JavaScript -->
  <script src="{{ '/assets/js/theme-manager.js' | relative_url }}"></script>
  <script src="{{ '/assets/js/textbook-engine.js' | relative_url }}"></script>
  <script src="{{ '/assets/js/widget-engine.js' | relative_url }}"></script>
  <script src="{{ '/assets/js/code-toggle.js' | relative_url }}"></script>
</body>
</html>
