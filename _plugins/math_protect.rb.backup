# Jekyll plugin to protect math blocks from kramdown table parsing
# This preprocesses markdown to escape pipes inside $...$ math blocks
# so they don't get interpreted as table delimiters

module Jekyll
  module MathProtect
    MATH_PIPE_PLACEHOLDER = 'MATH_PIPE_PLACEHOLDER_XYZ123'
    
    def self.protect_math(content)
      return content unless content.is_a?(String)
      return content unless content.include?('$') && content.include?('|')
      
      # Protect inline math blocks: $...$
      # Match $...$ but be careful not to match $$...$$ (display math)
      result = content.dup
      
      # First, protect display math blocks ($$...$$) by replacing with placeholder
      display_math_placeholders = []
      result = result.gsub(/\$\$([^$]*?)\$\$/m) do |match|
        placeholder = "DISPLAY_MATH_PLACEHOLDER_#{display_math_placeholders.length}"
        display_math_placeholders << match
        placeholder
      end
      
      # Now protect inline math blocks: $...$ (but not $$)
      # Match $ followed by non-$ characters (non-greedy) followed by $
      # Be careful to not match $$...$$ which we already protected
      result = result.gsub(/(?<!\$)\$(?!\$)([^$\n]+?)\$(?!\$)/) do |match|
        math_content = $1
        # Only replace pipes if they're inside the math block
        # Replace | with a placeholder that we'll restore later
        if math_content.include?('|')
          protected = math_content.gsub(/\|/, MATH_PIPE_PLACEHOLDER)
          "$#{protected}$"
        else
          match  # Return unchanged if no pipes
        end
      end
      
      # Restore display math blocks
      display_math_placeholders.each_with_index do |math, index|
        result = result.gsub("DISPLAY_MATH_PLACEHOLDER_#{index}", math)
      end
      
      result
    end

    def self.restore_math(content)
      return content unless content.is_a?(String)
      return content unless content.include?(MATH_PIPE_PLACEHOLDER)
      # Restore pipes in math blocks
      content.gsub(MATH_PIPE_PLACEHOLDER, '|')
    end
  end

  # Hook into the markdown conversion process
  # Only process diffequations collection to avoid breaking other content
  Jekyll::Hooks.register [:pages, :documents], :pre_render do |doc|
    next unless doc.content.is_a?(String)
    # Only process if it's from the diffequations collection
    next unless doc.respond_to?(:collection) && doc.collection&.label == 'diffequations'
    
    if doc.content.include?('$') && doc.content.include?('|')
      begin
        protected = Jekyll::MathProtect.protect_math(doc.content)
        if protected && protected.is_a?(String) && protected.length > 0
          doc.content = protected
        else
          # If protection returns invalid content, don't modify
          Jekyll.logger.warn "MathProtect: Protection returned invalid content, skipping"
        end
      rescue => e
        # If protection fails, log error but don't break the build
        Jekyll.logger.warn "MathProtect plugin error: #{e.message}"
        Jekyll.logger.warn e.backtrace.first(3).join("\n")
      end
    end
  end

  Jekyll::Hooks.register [:pages, :documents], :post_render do |doc|
    next unless doc.output.is_a?(String)
    # Only process if it's from the diffequations collection
    next unless doc.respond_to?(:collection) && doc.collection&.label == 'diffequations'
    
    if doc.output.include?(Jekyll::MathProtect::MATH_PIPE_PLACEHOLDER)
      begin
        restored = Jekyll::MathProtect.restore_math(doc.output)
        if restored && restored.is_a?(String) && restored.length > 0
          doc.output = restored
        else
          # If restoration returns invalid content, don't modify
          Jekyll.logger.warn "MathProtect: Restoration returned invalid content, skipping"
        end
      rescue => e
        # If restoration fails, log error but don't break the build
        Jekyll.logger.warn "MathProtect restoration error: #{e.message}"
        Jekyll.logger.warn e.backtrace.first(3).join("\n")
      end
    end
  end
end
